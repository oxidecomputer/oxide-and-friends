# Oxide and Friends: November 24th, 2025

## A Grown-up ZFS Data Corruption Bug

We've been hosting a live show weekly on Mondays at 5p for about an hour,
and recording them all; here is
[the recording](https://youtu.be/srKYxF66A0c).

Hey hey! We recently tripped over a ZFS data corruption bugâ€“introduced over 18
years ago! Bryan and Adam discuss with members of the Oxide team as well as
Matt Ahrens, the co-inventor of ZFS.

In addition to
[Bryan Cantrill](https://bsky.app/profile/bcantrill.bsky.social) and
[Adam Leventhal](https://bsky.app/profile/ahl.bsky.social),
speakers included
Alan Hanson,
[Matt Keeter](https://hachyderm.io/@mjk),
Andy Fiddaman,
James MacMahon,
and special guest, Matt Ahrens.

Previously, on Oxide and Friends:
- [OxF s4e6 - Crucible: the Oxide Storage Service](https://oxide-and-friends.transistor.fm/episodes/crucible-the-oxide-storage-service)
- [OxF s5e28 - Systems Software in the Large](https://oxide-and-friends.transistor.fm/episodes/systems-software-in-the-large)

Some of the topics we hit on, in the order that we hit them:

- [Upstairs panics with decryption failure: DecryptionError resulting from a bad extent #1788](https://github.com/oxidecomputer/crucible/issues/1788)
- [ZFS fsync can trigger ZIL transaction reordering and data corruption #17734](https://www.illumos.org/issues/17734)
- [RFD 177: Implementation of Data Storage](https://rfd.shared.oxide.computer/rfd/0177)
- [the "fix" that introduced data corruption](https://illumos.org/opensolaris/bugdb/bug.html#!6535160)
- PRs needed!

At 48:00, Code listing for the reproducer program.

```rust
use rand::prelude::*;
use anyhow::Result;
use std::fs::File;

fn fill(rng: &mut ThreadRng, path: &str) -> Result<()> {
        let mut v = vec![0u8; 64*1024*1024];
        rng.fill(&mut v[..]);
        std::fs::write(path, v)?;
        Ok(())
}

fn sync(path: &str) -> Result<()> {
        let file = File::open(path)?;
        file.sync_all()?;
        Ok(())
}

fn main() -> Result<()> {
        let mut i = 0;
        let mut rng = rand::rng();

        loop {
                // Write out an "original" extent file
                let p = format!("extent/{:03X}", i);
                println!("write {p}");
                fill(&mut rng, &p)?;
                sync(&p)?;

                // Simulate an extent being copied via the repair API
                let p = format!("extent/{:03X}.copy", i);
                println!("write {p}");
                fill(&mut rng, &p)?;
                sync(&p)?;

                // Copy over then sync
                println!("copy {p}!");

                std::fs::copy(
                        // from
                        format!("extent/{:03X}.copy", i),
                        // to
                        format!("extent/{:03X}", i),
                )?;

                sync(&format!("extent/{:03X}", i))?;

                // Next extent
                i += 1;
        }

        Ok(())
}
```
```

If we got something wrong or missed something, please file a PR!
Our next show will likely be on Monday at 5p Pacific Time on our Discord
server; stay tuned to our Mastodon feeds for details, or [subscribe to this
calendar](https://calendar.google.com/calendar/ical/c_318925f4185aa71c4524d0d6127f31058c9e21f29f017d48a0fca6f564969cd0%40group.calendar.google.com/public/basic.ics).
We'd love to have you join us, as we always love to hear from new speakers!

